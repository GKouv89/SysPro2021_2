2η Εργασία Προγραμματισμού Συστήματος
Ονοματεπώνυμο: Γεωργία Κουτίβα
Αριθμός Μητρώου: 1115201700060

Οδηγίες μεταγλώττισης:
    make για μεταγλώττιση τόσο του travelMonitor όσο και του Monitor. Απαραίτηση η ύπαρξη του φάκελου build (ας είναι αρχικά κενός) για να λειτουργήσει σωστά.
Οδηγίες εκτέλεσης εφαρμογής:
    Όπως αναγράφεται στην εκφώνηση. Τα flags -m κ.λπ. μπορούν να μπουν και με διαφορετική σειρά, αρκεί να παίρνουν την σωστή τιμή
Οδηγίες εκτέλεσης bashScript:
    Όπως αναγράφεται στην εκφώνηση.

Επιπλέον:
    make clean_log για απαλοιφή όλων των log files που έχουν παραχθεί
    make clean_pipes για διαγραφή των named pipes σε περίπτωση μη ομαλού τερματισμού του προγράμματος.
    make clean για απαλοιφή των 2 εκτελέσιμων και των περιεχομένων του φακέλου build.
    

ΔΟΜΕΣ ΠΟΥ ΧΡΗΣΙΜΟΠΟΙΗΘΗΚΑΝ
    Γονιός:
        1) Set of Bloom Filters: Ένα για κάθε ιό, χρησιμοποιείται από τον γονιό για να κρατάει τα bloomfilter από όλα τα παιδιά
        για αυτόν τον ιό. Η θέση στον πίνακα των bloomfilters αντιστοιχεί στην θέση του παιδιού στον πίνακα με τα file descriptors.
        Δηλαδή, τα bloom filters του παιδιού του οποίου ο file descriptor για το διάβασμα ή το γράψιμο βρίσκεται στην θέση 0 
        των δύο πινάκων αυτών θα τοποθετηθούν στην θέση 0 στα set για τους ιούς των οποίων έχει bloom filter. 
        2) Ένα hashmap που χρησιμοποιείται ως lookup table αντιστοίχισης χώρας-παιδιού που την έχει αναλάβει. Περνώντας την λίστα
        με τα directories αλφαβητικά ταξινομημένα με round robin τρόπο, στο hashmap εισάγεται μαζί με την χώρα και το ποιο παιδί είναι 
        που την ανέλαβε.
        3) Οι οντότητες namedRequests. Ένα namedRequest αποτελείται από μία χώρα, μία ημερομηνία και 3 μετρητές. Η χώρα και η ημερομηνία
        αντιστοιχούν στα πεδία date και countryTo της /travelRequest, και οι μετρητές δείχνουν πόσες αιτήσεις ταξιδιού προς την συγκεκριμένη
        χώρα, την συγκεκριμένη ημερομηνία έχουν γίνει συνολικά, πόσες έχουν γίνει δεκτές και πόσες έχουν απορριφθεί. Φυσικά, η αίτηση
        αφορά συγκεκριμένο εμβόλιο, επομένως όλα τα namedRequests που αφορούν έναν ιό αποθηκεύονται σε μία οντότητα virusRequest. Αυτό
        είναι ένα vector όλων των namedRequests που αφορούν τον συγκεκριμένο ιό. Ο γονιός έχει ένα hashmap από virusRequest οντότητες.
    Παιδί:
        Το παιδί έχει τα 3 hashmaps με ιούς, χώρες και πολίτες που χρησιμοποιούνταν για την πρώτη εργασία, και χρησιμοποιεί ακριβώς τον ίδιο
        τρόπο ανάγνωσης των αρχείων που χρησιμοποιούνταν και στην πρώτη. Η μόνη αλλαγή έχει επέλθει στην οντότητα 'Country', που έχει το πεδίο
        index, έγκυρο για τον γονέα και αντιστοιχεί στον αριθμό του παιδιού που διαχειρίζεται τα bloomfilters και skiplists αυτής της χώρας, 
        και maxFile, έγκυρο για το παιδί και αντιστοιχεί στον αριθμό του τελευταίου αρχείου που έχει διαβάσει στον φάκελο αυτής της χώρας, ώστε
        να γνωρίζει από ποιο αρχείο να ξεκινήσει σε περίπτωση που προστεθούν νέα.


ΠΡΩΤΟΚΟΛΛΟ ΕΠΙΚΟΙΝΩΝΙΑΣ
    1) Γενικά: 
        Για την επικοινωνία ενός γονιού με ένα child process χρησιμοποιούνται 2 pipes: ένα στο οποίο ο γονιός γράφει και το
        παιδί διαβάζει, και ένα για την αντίθετη κατεύθυνση επικοινωνίας. Για κάθε στοιχείο το οποίο γράφεται σε μία κατεύθυνση,
        ακολουθεί μία εγγραφή επιβεβαίωσης λήψης (ο αριθμός 1) στην άλλη κατεύθυνση. 
    2) Αρχικοποίηση
        2.1) Το μέγεθος του buffer, καθώς και το μέγεθος των bloomfilters μεταφέρεται στο παιδί ως int. Μετά, μεταφέρεται το
            μήκος του ορίσματος input_dir σε όλα τα παιδιά, και το κάθε παιδί επιβεβαιώνει ότι το έλαβε. 
            Μετά ο γονιός σπάει σε κομμάτια το όνομα του αρχείου ώστε να χωράει στο bufferSize, 
            και μόνο αφού ληφθεί ολόκληρο το όνομα του φακέλου στέλνεται επιβεβαίωση στον γονέα. Αφού ο γονιός λάβει τα 
            ονόματα των υποφακέλων με αλφαβητική σειρά, ακολουθεί την ίδια διαδικασία για το κάθε ένα: στέλνει το μήκος, 
            λαμβάνει επιβεβαίωση από το παιδί, σπάει το όνομα σε κομμάτια και αφού ληφθούν όλα λαμβάνει μία ακόμα επιβεβαίωση.
            Όταν δεν έχει πλέον άλλα ονόματα φακέλων να στείλει, στέλνει σε κάθε μόνιτορ την λέξη END αφού έχει στείλει και το 
            μήκος της.
        2.2) Ο γονιός δημιουργεί ένα file descriptor set με όλα του τα reading file descriptors και μπλοκάρει με την select.
            Όταν η select επιστρέψει, διατρέχει όλα τα file descriptors στο set, και για κάθε ένα file descriptor διαθέσιμο για ανάγνωση,
            διαβάζει τα bloom filters αυτού του παιδιού. Διαβάζει το μήκος του ονόματος του ιού, τον ίδιο τον ιό, αν χρειάζεται δημιουργεί το αντίστοιχο
            bloom filter set, και μετά διαβάζει κομμάτια μεγέθους bufferSize μέχρις ότου να διαβάσει όλο το filter, και στέλνει επιβεβαίωση 
            στο παιδί ότι έλαβε οκ τα δεδομένα. Αν λάβει END αντί για όνομα ιού, δεν υπάρχει άλλο bloom filter προς ανάγνωση από αυτό το παιδί.
            Μετά από ένα πέρασμα του set, βγάζει όλα τα file descriptors από τα οποία έλαβε bloom filters από το set, και ξανακαλεί την select μέχρις ότου να
            μην υπάρχουν άλλα file descriptors από τα οποία να περιμένει δεδομένα.
    3) Εντολές
        3.1) Γενικά:
            Τόσο ο γονιός όσο και το παιδί μπλοκάρουν με την select call. Ο γονιός μπλοκάρει μέσω της select call καθώς έτσι ήταν ευκολότερο να διαχειριστεί η
            περίπτωση λήψης σήματος όσο αναμένεται είσοδος από τον χρήστη. Το παιδί μπλοκάρει μέχρις ότου ο γονέας του απευθυνθεί για κάποιο ερώτημα.
        3.2) /travelRequest, περίπτωση όπου πρέπει να ελέγξουμε το skiplist ενός ιού.
            Ο γονιός απευθύνει στο Monitor process ένα ερώτημα της μορφής: checkSkiplist citizenID virusName. Στέλνει το μήκος του ερωτήματος και κατόπιν το ίδιο,
            σε τμήματα αν χρειάζεται. Δεν περιμένει για επιβεβαίωση, παρά μόνο για την ίδια την απάντηση. Το παιδί ελέγχει για τον εμβολιασμό αυτού του πολίτη
            και απαντά είτε YES vaccinationDate είτε NO. Αν η απάντηση είναι αρνητική, περιμένει για τυχόν επόμενο ερώτημα. Αν όχι, περιμένει να λάβει από τον 
            γονιό απάντηση για το αν η ημερομηνία εμβολιασμού είναι εντός έξι μηνών από την ημερομηνία ταξιδιού.
        3.3) /addVaccinationRecords.
            Ο γονιός στέλνει το SIGUSR1 στο παιδί που διαχειρίζεται την εν λόγω χώρα. Όταν το παιδί μεταβεί στην συνάρτηση που ελέγχει την τιμή του ανάλογου flag
            για το SIGUSR1 σήμα, αν το βρει set ενημερώνει τον γονιό ότι περιμένει να λάβει το όνομα της χώρας στον φάκελο της οποίας προστέθηκαν νέα αρχεία. 
            O γονιός μπλοκάρει μέχρις ότου έρθουν τα νέα bloom filters, ακριβώς με τον ίδιο τρόπο που περιγράφεται στο 2.2, 
            απλά γνωρίζοντας ότι αναμένει να διαβάσει από συγκεκριμένο παιδί.
                Παραδοχή όχι σχετική με το πρωτόκολλο επικοινωνίας: το παιδί δεν γνωρίζει πόσα αρχεία προστέθηκαν, απλά αναμένει ότι, αν ο εν λόγω φάκελος είναι
                ο Greece και το τελευταίο αρχείο που είχε διαβάσει ήταν το αρχείο #3 (Greece/Greece-3.txt), θα προστέθηκε τουλάχιστον το αρχείο Greece-4.txt. 
                Θα αποπειραθεί να διαβάσει τα Greece-4, Greece-5 μέχρις ότου η fopen αποτύχει: τότε θεωρεί ότι δεν έχει προστεθεί άλλο αρχείο.
        3.4) /searchVaccinationStatus
            Ο γονιός αποστέλλει το ερώτημα checkVacc citizenID σε όλα τα παιδιά με τον συνήθη τρόπο, και περιμένει απάντηση από *όλα* τα παιδιά, είτε θετική είτε
            αρνητική. Μπλοκάρει για τις απαντήσεις με τρόπο παρόμοιο με την λήψη των bloom filters. Αν λάβει απάντηση "NO SUCH CITIZEN" απ'όλα τα παιδιά, 
            ο πολίτης με το εν λόγω citizenID δεν υπήρχε σε κανένα αρχείο. Αν λάβει διαφορετική απάντηση,  αυτή θα είναι τα στοιχεία του πολίτη (ένα string όπως
            οι 2 πρώτες γραμμές του ενδεικτικού output στην εκφώνηση), οπότε επιβεβαιώνει ότι έλαβε τα στοιχεία και μπλοκάρει μόνο για το συγκεκριμένο file 
            descriptor μέχρις ότου το παιδί διαβάσει την επιβεβαίωση και αρχίσει να στέλνει ζεύγη ιού (όπου και εκεί ο γονιός στέλνει επιβεβαίωση) και 
            κατάστασης/ημερομηνίας εμβολιασμού (ακόμα μία επιβεβαίωση λήψης από τον γονιό). Ο γονιός με το που λάβει ένα τέτοιο ζεύγος ολόκληρο, το εκτυπώνει. 

ΔΙΑΧΕΙΡΙΣΗ ΣΗΜΑΤΩΝ

    Λήψη Σήματος SIGINT/SIGQUIT από το Monitor process
        Για την λήψη σημάτων SIGINT/SIGQUIT τόσο από το monitor process όσο και από την διεργασία-γονιό γίνεται η παραδοχή ότι αυτή είναι δυνατή μόνο κατόπιν
        της αποστολής των bloom filters απ'όλα τα παιδιά και της λήψης αυτών από τον γονιό. Επίσης, αν η διεργασία που λαμβάνει το σήμα είναι στην μέση ενός 
        ερωτήματος (δύσκολο να συμβεί, καθώς η απόκριση των monitors στα ερωτήματα του γονιού είναι άμεση) τότε το σήμα θα χειριστεί μετά την ολοκλήρωση του 
        ερωτήματος. Αυτό ισχύει και για το σήμα SIGCHLD που θα λάβει ο γονιός για να αντικαταστήσει το παιδί που έλαβε το SIGINT/SIGQUIT. Αν το σήμα ληφθεί 
        όσο είτε το Monitor process περιμένει ερώτημα από τον γονιό είτε ο γονιός είσοδο από τον χρήστη, τότε ο χειρισμός του σήματος είναι άμεσος.

        Οι handlers θέτουν ένα flag στην τιμή 1, και η διεργασία ελέγχει στις προαναφερθείσες στιγμές (μετά από ένα ερώτημα ή αν λάβει EINTR στην select)
        ελέγχει την τιμή του flag και προβαίνει στις ανάλογες ενέργειες.

        Η αποστολή του σήματος SIGINT/SIGQUIT στον γονιό και στα παιδιά έχει δοκιμαστεί μέσω του terminal με την εντολή kill -2 process_id.


########################################################################################

BASH SCRIPT

    Γίνεται βασικός έλεγχος για τα ορίσματα. Αν υπάρχει το αρχείο inputFile.txt και αν *δεν* υπάρχει ο φάκελος input_dir, συνεχίζουμε
    στο κύριο σώμα του script. Διαβάζουμε όλες τις γραμμές του αρχείου και συγκεντρώνονται τα ονόματα όλων των χωρών σε έναν πίνακα.
    Αν μία χώρα υπάρχει ήδη στον πίνακα, η εκτέλεση προχωρά στην επόμενη γραμμή, αλλιώς προστίθεται ένα στοιχείο σε έναν associative πίνακα.
    Αυτός ο πίνακας για κάθε χώρα κρατά τον αριθμό του αρχείου στο οποίο πρόκειται να γράψει την επόμενη εγγραφή, επομένως αρχικοποιείται με 0.
    Δημιουργείται ο φάκελος της χώρας και numFilesPerDirectory κενά αρχεία μέσα στον φάκελο. Αφού αρχικοποιηθεί πλήρως αυτός ο πίνακας, 
    γίνεται ένα δεύτερο πέρασμα του αρχείου. Βρίσκεται η χώρα της γραμμής, και γράφεται αυτή στο αρχείο που υποδηλώνεται από τον roundRobin πίνακα,
    και το στοιχείο αυτού που αντιστοιχεί στην χώρα ανανεώνεται (προτίθεται ένα και γίνεται % numFilesPerDirectory ώστε αν χρειαστεί 
    να επιστρέψουμε στο πρώτο αρχείο).
